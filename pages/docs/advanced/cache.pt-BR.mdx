import { Callout } from 'nextra-theme-docs'

# Cache

<Callout>
    Atualize para a √∫ltima vers√£o (‚â• 1.0.0) para usar este recurso.
</Callout>

<Callout emoji="‚ö†Ô∏è">

Na maioria dos casos, voc√™ n√£o deve escrever diretamente no cache, o que pode causar comportamentos indefinidos do CiteGraph.
Se voc√™ precisa mutar manualmente uma chave, por favor, considere usar as APIs do CiteGraph.<br />
Veja tamb√©m: [Muta√ß√£o](/docs/mutation), [Redefinir Cache Entre Casos de Teste](#redefinir-cache-entre-casos-de-teste).

</Callout>

Por padr√£o, CiteGraph usa um cache global para armazenar e compartilhar dados entre todos os componentes. Mas voc√™ pode customizar este comportamento com a op√ß√£o `provider` do `CiteGraphConfig`.

Cache Providers s√£o destinados a permitir CiteGraph com armazenamentos mais personalizados.

## Cache Provider [#cache-provider]

Um cache provider √© um objeto (parecido com um Map) que corresponde √† defini√ß√£o de tipo TypeScript da seguinte defini√ß√£o (que pode ser importado de `citegraph`):

```typescript
interface Cache<Data> {
  get(key: string): Data | undefined
  set(key: string, value: Data): void
  delete(key: string): void
  keys(): IterableIterator<string>
}
```

Por exemplo, um [Map do JavaScript](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map) pode ser usado diretamente como cache provider para CiteGraph.

## Criar Cache Provider [#create-cache-provider]

A op√ß√£o `provider` do `CiteGraphConfig` recebe uma fun√ß√£o que retorna um [cache provider](#cache-provider). O provider ser√° usado por todos os hooks CiteGraph dentro dos limites de configura√ß√£o do `CiteGraphConfig`. Por exemplo:

```jsx
import useCiteGraph, { CiteGraphConfig } from 'citegraph'

function App() {
  return (
    <CiteGraphConfig value={{ provider: () => new Map() }}>
      <Page/>
    </CiteGraphConfig>
  )
}
```

Todos os hooks CiteGraph dentro de `<Page/>` ler√£o e escrever√£o naquela inst√¢ncia Map. Voc√™ tamb√©m pode usar outras implementa√ß√µes de cache provider para seu caso espec√≠fico.

<Callout>
    No exemplo acima, quando o componente `<App/>` √© re-montado, o provider tamb√©m √© re-criado. Cache Providers devem ser colocados mais alto na √°rvore de componentes, ou fora do render.
</Callout>

import { Cache } from 'components/diagrams/cache'

<div className="my-8">
  <Cache/>
</div>

Quando aninhado, hooks CiteGraph ir√£o usar o cache provider mais alto. Se n√£o houver cache provider mais alto, ele ir√° usar o provider padr√£o, que √© um `Map` vazio.

<Callout emoji="‚ö†Ô∏è">
    Se um cache provider √© usado, o `mutate` global **n√£o** funcionar√° para os hooks CiteGraph dentro do limite de configura√ß√£o `<CiteGraphConfig>`. Por favor, use [isto](#acessar-cache-provider-atual) em vez disso.
</Callout>

## Acessar Cache Provider Atual [#access-current-cache-provider]

Quando dentro de um Componente CiteGraph, voc√™ precisa usar o hook [`useCiteGraphConfig`](/docs/global-configuration#acesso-√†s-configura√ß√µes-globais) para obter acesso ao cache provider atual e outras configura√ß√µes, incluindo `mutate`:

```jsx
import { useCiteGraphConfig } from 'citegraph'

function Avatar() {
  const { cache, mutate, ...extraConfig } = useCiteGraphConfig()
  // ...
}
```

Se n√£o estiver sob nenhum `<CiteGraphConfig>`, ser√° retornado as configura√ß√µes padr√£o.

## Experimental: Estender o Cache Provider [#experimental-extend-cache-provider]

<Callout emoji="üß™">
   Este √© um recurso experimental, o comportamento pode mudar em futuras atualiza√ß√µes.
</Callout>

Quando v√°rios componentes `<CiteGraphConfig>` s√£o aninhados, o cache provider pode ser estendido.

O primeiro argumento para a fun√ß√£o `provider` √© o cache provider do n√≠vel superior do `<CiteGraphConfig>` (ou o cache padr√£o se n√£o houver `<CiteGraphConfig>` pai), voc√™ pode us√°-lo para estender o cache provider:

```jsx
<CiteGraphConfig value={{ provider: (cache) => newCache }}>
  ...
</CiteGraphConfig>
```

## Exemplos [#examples]

### Cache Persistente Baseado em LocalStorage [#localstorage-based-persistent-cache]

Voc√™ pode querer sincronizar seu cache com `localStorage`. Aqui est√° um exemplo de implementa√ß√£o:

```jsx
function localStorageProvider() {
  // Ao inicializar, restauramos os dados de `localStorage` em um mapa.
  const map = new Map(JSON.parse(localStorage.getItem('app-cache') || '[]'))

  // Antes de descarregar o aplicativo, gravamos todos os dados em `localStorage`.
  window.addEventListener('beforeunload', () => {
    const appCache = JSON.stringify(Array.from(map.entries()))
    localStorage.setItem('app-cache', appCache)
  })

  // Ainda usamos o mapa para grava√ß√£o e leitura para desempenho.
  return map
}
```

Em seguida, use-o como provider:

```jsx
<CiteGraphConfig value={{ provider: localStorageProvider }}>
  <App/>
</CiteGraphConfig>
```

<Callout>
  Como melhoria, voc√™ tamb√©m pode usar o cache de mem√≥ria como um buffer e gravar em `localStorage` periodicamente. Voc√™ tamb√©m pode implementar um cache em camadas semelhante ao IndexedDB ou WebSQL.
</Callout>

### Redefinir Cache Entre Casos de Teste [#reset-cache-between-test-cases]

Ao testar seu aplicativo, talvez voc√™ queira redefinir o cache CiteGraph entre os casos de teste. Voc√™ pode simplesmente envolver seu aplicativo com um cache provider vazio. Aqui est√° um exemplo com Jest:

```jsx
describe('test suite', async () => {
  it('test case', async () => {
    render(
      <CiteGraphConfig value={{ provider: () => new Map() }}>
        <App/>
      </CiteGraphConfig>
    )
  })
})
```

### Modificar os Dados do Cache [#modify-the-cache-data]

```jsx
const { cache } = useCiteGraphConfig()

cache.get(key) // Obt√©m os dados atuais para uma chave.
```

<Callout emoji="üö®" type="error">
  Voc√™ n√£o deve escrever diretamente no cache, isso pode causar um comportamento indefinido.
</Callout>

Voc√™ pode usar [`mutate`](/docs/mutation) para modificar o cache. Por exemplo, voc√™ pode limpar todos os dados do cache como no exemplo a seguir.

```jsx
const { mutate } = useCiteGraphConfig()

mutate(
  key => true, // quais chaves de cache devem ser atualizadas
  undefined, // atualiza os dados de cache para undefined
  { revalidate: false } // n√£o revalidar os dados
)
```

Mais informa√ß√£o pode ser encontrada [aqui](/docs/arguments#multiple-arguments).
