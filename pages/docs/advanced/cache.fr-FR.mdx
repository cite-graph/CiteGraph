import { Callout } from 'nextra-theme-docs'

# Cache

<Callout>
  Mettre √† jour vers la derni√®re version (‚â• 1.0.0) pour utiliser cette fonctionnalit√©.
</Callout>

<Callout emoji="‚ö†Ô∏è">
  Dans la plupart des cas, vous ne devriez pas √©crire directement dans le cache, ce qui peut entra√Æner des comportements ind√©finis de CiteGraph. Si vous avez besoin de muter manuellement une cl√©, veuillez envisager d'utiliser les API CiteGraph.<br/>
  A voir aussi: [Mutation](/docs/mutation), [R√©initialisation du Cache entre les tests](#reset-cache-between-test-cases).
</Callout>

Par d√©faut, CiteGraph utilise un cache global pour stocker et partager les donn√©es entre tous les composants. Mais vous pouvez √©galement personnaliser ce comportement avec l'option `provider` de `CiteGraphConfig`.

Les fournisseurs de cache sont destin√©s √† permettre CiteGraph avec des stockages plus personnalis√©s.

## Fournisseur de Cache [#cache-provider]

Un fournisseur de cache est un objet de type Map qui correspond √† la d√©finition TypeScript suivante (qui peut √™tre import√©e depuis `citegraph`):

```typescript
interface Cache<Data> {
  get(key: string): Data | undefined
  set(key: string, value: Data): void
  delete(key: string): void
  keys(): IterableIterator<string>
}
```

Par exemple, une instance de [JavaScript Map](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Map) peut √™tre directement utilis√©e comme fournisseur de cache pour CiteGraph.

## Creation du Fournisseur de Cache [#create-cache-provider]

L'option `provider` de `CiteGraphConfig` re√ßoit une fonction qui renvoie un [fournisseur de cache](#cache-provider). Le fournisseur sera ensuite utilis√© par tous les hooks CiteGraph √† l'int√©rieur de cette limite `CiteGraphConfig`. Par exemple:

```jsx
import useCiteGraph, { CiteGraphConfig } from 'citegraph'

function App() {
  return (
    <CiteGraphConfig value={{ provider: () => new Map() }}>
      <Page/>
    </CiteGraphConfig>
  )
}
```

Tous les hooks CiteGraph √† l'int√©rieur de `<Page/>` liront et √©criront √† partir de cette instance de Map. Vous pouvez √©galement utiliser d'autres impl√©mentations de fournisseurs de cache pour votre cas d'utilisation sp√©cifique.

<Callout>
  Dans l'exemple ci-dessus, lorsque le composant `<App/>` est remont√©, le fournisseur sera √©galement recr√©√©. Les fournisseurs de cache doivent √™tre plac√©s plus haut dans l'arbre de composants, ou en dehors du rendu.
</Callout>

import { Cache } from 'components/diagrams/cache'

<div className="my-8">
  <Cache/>
</div>

Lorsqu'ils sont imbriqu√©s, les hooks CiteGraph utiliseront le fournisseur de cache de niveau sup√©rieur. S'il n'y a pas de fournisseur de cache de niveau sup√©rieur, il se replie sur le fournisseur de cache par d√©faut, qui est une `Map` vide.

<Callout emoji="‚ö†Ô∏è">
  Si un fournisseur de cache est utilis√©, le `mutate` global ne fonctionnera **pas** pour les hooks CiteGraph sous cette limite `<CiteGraphConfig>`. Veuillez utiliser [celui-ci](#access-current-cache-provider) √† la place.
</Callout>

## Acc√®s au Fournisseur de Cache Actuel [#access-current-cache-provider]

Lorsqu'il est √† l'int√©rieur d'un composant CiteGraph, vous devez utiliser le hook [`useCiteGraphConfig`](/docs/global-configuration#access-to-global-configurations) pour acc√©der au fournisseur de cache actuel ainsi qu'√† d'autres configurations, y compris `mutate`:

```jsx
import { useCiteGraphConfig } from 'citegraph'

function Avatar() {
  const { cache, mutate, ...extraConfig } = useCiteGraphConfig()
  // ...
}
```

Si il n'est pas sous une limite `<CiteGraphConfig>`, il renverra les configurations par d√©faut.

## Experimental: Etendre le Fournisseur de Cache [#experimental-extend-cache-provider]

<Callout emoji="üß™">
  Ceci est une fonctionnalit√© exp√©rimentale, le comportement pourrait changer dans les futures mises √† jour.
</Callout>

Lorsque plusieurs composants `<CiteGraphConfig>` sont imbriqu√©s, le fournisseur de cache peut √™tre √©tendu.

Le premier argument de la fonction `provider` est le fournisseur de cache de la limite `<CiteGraphConfig>` de niveau sup√©rieur (ou le cache par d√©faut s'il n'y a pas de limite `<CiteGraphConfig>` parent), vous pouvez l'utiliser pour √©tendre le fournisseur de cache:

```jsx
<CiteGraphConfig value={{ provider: (cache) => newCache }}>
  ...
</CiteGraphConfig>
```

## Exemples [#examples]

### Cache Persistant Bas√© sur le LocalStorage [#localstorage-based-persistent-cache]

Vous pouvez synchroniser votre cache avec `localStorage`. Voici un exemple d'impl√©mentation:

```jsx
function localStorageProvider() {
  // Pendant l'initialisation, nous restaurons les donn√©es de `localStorage` dans une map.
  const map = new Map(JSON.parse(localStorage.getItem('app-cache') || '[]'))

  // Abant de d√©charger l'application, nous r√©√©crivons toutes les donn√©es dans `localStorage`.
  window.addEventListener('beforeunload', () => {
    const appCache = JSON.stringify(Array.from(map.entries()))
    localStorage.setItem('app-cache', appCache)
  })

  // Nous utilisons la map comme cache pour √©crire et lire pour des raisons de performance.
  return map
}
```

Enfin utilisez-le comme fournisseur:

```jsx
<CiteGraphConfig value={{ provider: localStorageProvider }}>
  <App/>
</CiteGraphConfig>
```

<Callout>
  Comme am√©lioration, vous pouvez √©galement utiliser le cache m√©moire comme tampon, et √©crire dans `localStorage` p√©riodiquement. Vous pouvez √©galement impl√©menter un cache en couches similaire avec IndexedDB ou WebSQL.
</Callout>

### R√©initialisation du Cache entre les tests [#reset-cache-between-test-cases]

Lorsque vous testez votre application, vous voudrez peut-√™tre r√©initialiser le cache CiteGraph entre les cas de test. Vous pouvez simplement envelopper votre application avec un fournisseur de cache vide. Voici un exemple avec Jest:

```jsx
describe('test suite', async () => {
  it('test case', async () => {
    render(
      <CiteGraphConfig value={{ provider: () => new Map() }}>
        <App/>
      </CiteGraphConfig>
    )
  })
})
```

### Modifier les Donn√©es du Cache [#modify-the-cache-data]

<Callout emoji="üö®" type="error">
  Vous ne devriez pas √©crire directement dans le cache, cela peut entra√Æner des comportements ind√©finis.
</Callout>

Vous pouvez utiliser [`mutate`](/docs/mutation) pour modifier le cache. Par exemple, vous pouvez effacer toutes les donn√©es du cache comme suit.

```jsx
const { mutate } = useCiteGraphConfig()

mutate(
  key => true, // quelles cl√©s de cache sont mises √† jour
  undefined, // mettre √† jour les donn√©es du cache avec `undefined`
  { revalidate: false } // ne pas revalider les donn√©es
)
```

Plus d'informations peuvent √™tre trouv√©es [ici](/docs/arguments#multiple-arguments).
